<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Purchase | Inventory System</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>‚úèÔ∏è Edit Purchase Order</h1>
     <nav>
      <a href="index.html">Dashboard</a>
      <a href="documents.html">Documents</a>
      <a href="log.html">Activity Log</a>
      <a href="setting.html" style="text-decoration: none;"><button>‚öôÔ∏è Setting</button></a>
      <button onclick="toggleTheme()">üåì Mode</button>
      <button onclick="logout()">üö™ Logout</button>
      <div id="adminInfo">Logged in as: <span id="adminName"></span></div>
    </nav>
  </header>


  <section>
    <div id="loadingMessage">Loading purchase details...</div>
    
    <div id="purchaseForm" style="display: none;">
      <div class="form-row">
        <div class="form-group">
          <label for="editSupplierName">Supplier Name:</label>
          <input type="text" id="editSupplierName" placeholder="Enter supplier name">
        </div>
        <div class="form-group">
          <label for="editPurchaseDate">Purchase Date:</label>
          <input type="date" id="editPurchaseDate">
        </div>
      </div>

      <div class="form-group">
        <label for="editPurchaseNotes">Notes (Optional):</label>
        <textarea id="editPurchaseNotes" placeholder="Any additional notes..." rows="3"></textarea>
      </div>

      <h3>Purchase Items</h3>
      <div class="search-product-section">
        <input type="text" id="productSearch" placeholder="Search by SKU or product name..." class="search-input">
        <div id="productResults" class="product-results"></div>
      </div>

      <div class="purchase-items-container">
        <div id="editPurchaseItems">
          <!-- Dynamic edit purchase items will be added here -->
        </div>
        <button id="addEditProductItem" class="primary-btn" style="margin-top: 10px;">+ Add Product Item</button>
      </div>

      <div class="purchase-summary">
        <div class="total-amount-display">
          <strong>Total Amount: RM <span id="editTotalPurchaseAmount">0.00</span></strong>
        </div>
      </div>

      <div class="form-actions" style="display: flex; gap: 10px; margin-top: 25px;">
        <button id="updatePurchaseBtn" class="primary-btn">üíæ Update Purchase Order</button>
        <button id="printInvoiceBtn" class="success-btn">üñ®Ô∏è Print Invoice</button>
        <button id="cancelEditBtn" class="secondary-btn">‚úñÔ∏è Cancel</button>
        <button id="deletePurchaseBtn" class="danger-btn">üóëÔ∏è Delete Purchase</button>
      </div>
    </div>

    <div id="errorMessage" style="display: none; color: red; text-align: center; padding: 20px;">
      Failed to load purchase details. Please try again.
    </div>
  </section>

  <!-- JS -->
  <script src="js/setting.js" defer></script>
  <script src="js/script.js" defer></script>
  <script>
    document.documentElement.dataset.page = 'purchase-edit';
    
    // Purchase edit page specific functionality
    let currentPurchaseId = null;
    
    async function loadPurchaseDetails() {
      const params = new URLSearchParams(window.location.search);
      currentPurchaseId = params.get('id');
      
      if (!currentPurchaseId) {
        showError('No purchase ID provided');
        return;
      }
      
      try {
        const res = await apiFetch(`${API_BASE}/purchases/${currentPurchaseId}`);
        if (!res.ok) throw new Error('Failed to fetch purchase details');
        
        const purchase = await res.json();
        
        // Populate form
        qs('#editSupplierName').value = purchase.supplier || '';
        qs('#editPurchaseDate').value = purchase.purchaseDate ? new Date(purchase.purchaseDate).toISOString().split('T')[0] : '';
        qs('#editPurchaseNotes').value = purchase.notes || '';
        
        // Clear existing items
        qs('#editPurchaseItems').innerHTML = '';
        
        // Add items
        purchase.items.forEach(item => {
          addEditProductItem(item);
        });
        
        // Update total
        updateTotalAmount();
        
        // Load product search
        loadProductSearch();
        
        // Show form, hide loading
        qs('#loadingMessage').style.display = 'none';
        qs('#purchaseForm').style.display = 'block';
        
      } catch (e) {
        console.error('Load purchase error:', e);
        qs('#loadingMessage').style.display = 'none';
        showError('Failed to load purchase details: ' + e.message);
      }
    }
    
    function showError(message) {
      qs('#errorMessage').textContent = message;
      qs('#errorMessage').style.display = 'block';
    }
    
    function addEditProductItem(product = null) {
      const container = qs('#editPurchaseItems');
      const itemId = `edit-item-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
      
      const itemRow = document.createElement('div');
      itemRow.className = 'purchase-item-row';
      itemRow.id = itemId;
      
      itemRow.innerHTML = `
        <div class="form-group">
          <label>SKU</label>
          <input type="text" class="product-sku" placeholder="SKU" value="${product ? escapeHtml(product.sku || '') : ''}">
        </div>
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" class="product-name" placeholder="Product Name" value="${product ? escapeHtml(product.productName || '') : ''}">
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" class="product-quantity" placeholder="Qty" min="1" value="${product ? product.quantity : '1'}">
        </div>
        <div class="form-group">
          <label>Unit Price (RM)</label>
          <input type="number" class="product-price" placeholder="Price" step="0.01" min="0" value="${product ? product.purchasePrice : '0.00'}">
        </div>
        <div class="form-group">
          <label>Total (RM)</label>
          <input type="text" class="product-total" placeholder="Total" readonly value="${product ? product.totalAmount.toFixed(2) : '0.00'}">
        </div>
        <button class="danger-btn remove-item-btn" type="button" title="Remove Item">üóëÔ∏è</button>
      `;
      
      container.appendChild(itemRow);
      
      // Add event listeners for the new row
      const quantityInput = itemRow.querySelector('.product-quantity');
      const priceInput = itemRow.querySelector('.product-price');
      const totalInput = itemRow.querySelector('.product-total');
      
      const calculateTotal = () => {
        const qty = Number(quantityInput.value) || 0;
        const price = Number(priceInput.value) || 0;
        totalInput.value = (qty * price).toFixed(2);
        updateTotalAmount();
      };
      
      quantityInput.addEventListener('input', calculateTotal);
      priceInput.addEventListener('input', calculateTotal);
      
      // Remove row button
      itemRow.querySelector('.remove-item-btn').addEventListener('click', () => {
        itemRow.remove();
        updateTotalAmount();
      });
    }
    
    async function updatePurchaseOrder() {
      if (!currentPurchaseId) return;
      
      const supplier = qs('#editSupplierName').value.trim();
      const purchaseDate = qs('#editPurchaseDate').value;
      const notes = qs('#editPurchaseNotes').value.trim();
      
      if (!supplier) {
        alert('‚ö†Ô∏è Please enter supplier name.');
        return;
      }
      
      const items = [];
      const itemRows = qsa('#editPurchaseItems .purchase-item-row');
      
      if (itemRows.length === 0) {
        alert('‚ö†Ô∏è Please add at least one product item.');
        return;
      }
      
      for (const row of itemRows) {
        const sku = row.querySelector('.product-sku').value.trim();
        const productName = row.querySelector('.product-name').value.trim();
        const quantity = Number(row.querySelector('.product-quantity').value);
        const purchasePrice = Number(row.querySelector('.product-price').value);
        
        if (!sku || !productName || !quantity || !purchasePrice) {
          alert('‚ö†Ô∏è Please fill in all fields for each product item.');
          return;
        }
        
        if (quantity <= 0) {
          alert('‚ö†Ô∏è Please enter a valid quantity greater than 0.');
          return;
        }
        
        if (purchasePrice <= 0) {
          alert('‚ö†Ô∏è Please enter a valid purchase price greater than 0.');
          return;
        }
        
        items.push({
          sku,
          productName,
          quantity,
          purchasePrice
        });
      }
      
      const purchaseData = {
        supplier,
        purchaseDate: purchaseDate || new Date().toISOString().split('T')[0],
        notes,
        items
      };
      
      // Create confirmation message
      let confirmMessage = `Confirm Update Purchase Order:\n\nSupplier: ${supplier}\nItems: ${items.length}\n\nItems:\n`;
      items.forEach((item, index) => {
        confirmMessage += `${index + 1}. ${item.productName} (${item.sku}) - ${item.quantity} x RM ${item.purchasePrice.toFixed(2)} = RM ${(item.quantity * item.purchasePrice).toFixed(2)}\n`;
      });
      confirmMessage += `\nTotal Amount: RM ${purchaseData.items.reduce((sum, item) => sum + (item.quantity * item.purchasePrice), 0).toFixed(2)}`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        const res = await apiFetch(`${API_BASE}/purchases/${currentPurchaseId}`, {
          method: 'PUT',
          body: JSON.stringify(purchaseData)
        });
        
        if (res.ok) {
          alert('‚úÖ Purchase order updated successfully!');
          window.location.href = 'inventory.html';
        } else {
          const error = await res.json();
          alert(`‚ùå Failed to update purchase order: ${error.message}`);
        }
      } catch (e) {
        console.error('Update purchase order error:', e);
        alert('‚ùå Server connection error while updating purchase order.');
      }
    }
    
    async function deletePurchase() {
      if (!currentPurchaseId) return;
      
      if (!confirm(`‚ö†Ô∏è Are you sure you want to delete this purchase order?\n\nThis action cannot be undone and will revert inventory quantities.`)) return;
      
      try {
        const res = await apiFetch(`${API_BASE}/purchases/${currentPurchaseId}`, { method: 'DELETE' });
        if (res.status === 204) {
          alert('üóëÔ∏è Purchase order deleted successfully!');
          window.location.href = 'inventory.html';
        } else {
          alert('‚ùå Failed to delete purchase order.');
        }
      } catch (e) {
        console.error(e);
        alert('‚ùå Server connection error while deleting purchase order.');
      }
    }
    
    function printInvoice() {
      if (currentPurchaseId) {
        window.open(`${API_BASE}/purchases/invoice/${currentPurchaseId}`, '_blank');
      }
    }
    
    function cancelEdit() {
      if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
        window.location.href = 'inventory.html';
      }
    }
    
    // Initialize page
    window.addEventListener('load', async () => {
      const adminName = getUsername();
      if(qs('#adminName')) qs('#adminName').textContent = adminName;
      
      // Load purchase details
      await loadPurchaseDetails();
      
      // Bind events
      qs('#addEditProductItem')?.addEventListener('click', () => addEditProductItem());
      qs('#updatePurchaseBtn')?.addEventListener('click', updatePurchaseOrder);
      qs('#printInvoiceBtn')?.addEventListener('click', printInvoice);
      qs('#cancelEditBtn')?.addEventListener('click', cancelEdit);
      qs('#deletePurchaseBtn')?.addEventListener('click', deletePurchase);
    });
  </script>
</body>
</html>
