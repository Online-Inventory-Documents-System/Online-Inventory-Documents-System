<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Purchase | Inventory System</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>üõí Purchase Management</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="inventory.html">Inventory</a>
      <a href="purchase.html" class="active">Purchase</a>
      <a href="documents.html">Documents</a>
      <a href="log.html">Activity Log</a>
      <a href="setting.html" style="text-decoration: none;"><button>‚öôÔ∏è Setting</button></a>
      <button onclick="toggleTheme()">üåì Mode</button>
      <button onclick="logout()">üö™ Logout</button>
      <div id="adminInfo">Logged in as: <span id="adminName"></span></div>
    </nav>
  </header>

  <section>
    <div class="purchase-container">
      <!-- Purchase Form Section -->
      <div class="purchase-form-container slide-up">
        <h2>‚ûï New Purchase Order</h2>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="supplierName">Supplier Name *</label>
            <input type="text" id="supplierName" placeholder="Enter supplier name" required>
          </div>
          
          <div class="form-group">
            <label for="purchaseDate">Purchase Date</label>
            <input type="date" id="purchaseDate">
          </div>
          
          <div class="form-group">
            <label for="supplierPhone">Supplier Phone</label>
            <input type="text" id="supplierPhone" placeholder="Phone number">
          </div>
          
          <div class="form-group">
            <label for="supplierEmail">Supplier Email</label>
            <input type="email" id="supplierEmail" placeholder="Email address">
          </div>
          
          <div class="form-group full-width">
            <label for="supplierAddress">Supplier Address</label>
            <textarea id="supplierAddress" placeholder="Full address" rows="2"></textarea>
          </div>
        </div>

        <h3>üõçÔ∏è Purchase Items</h3>
        <div class="items-container">
          <div id="itemsList">
            <!-- Items will be dynamically added here -->
          </div>
          <button id="addItemBtn" class="primary-btn" style="width: 100%;">‚ûï Add Item</button>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="taxRate">Tax Rate (%)</label>
            <input type="number" id="taxRate" value="6" min="0" max="100" step="0.1">
          </div>
          
          <div class="form-group">
            <label for="shippingCost">Shipping Cost (RM)</label>
            <input type="number" id="shippingCost" value="0" min="0" step="0.01">
          </div>
          
          <div class="form-group">
            <label for="paymentMethod">Payment Method</label>
            <select id="paymentMethod">
              <option value="Cash">Cash</option>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="Credit Card">Credit Card</option>
              <option value="Check">Check</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="status">Status</label>
            <select id="status">
              <option value="Pending">Pending</option>
              <option value="Completed" selected>Completed</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </div>
          
          <div class="form-group full-width">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Additional notes..." rows="3"></textarea>
          </div>
        </div>

        <!-- Totals Section -->
        <div class="totals-section">
          <div class="total-row">
            <span>Subtotal:</span>
            <span id="subtotalDisplay">RM 0.00</span>
          </div>
          <div class="total-row">
            <span>Tax (<span id="taxRateDisplay">0</span>%):</span>
            <span id="taxAmountDisplay">RM 0.00</span>
          </div>
          <div class="total-row">
            <span>Shipping:</span>
            <span id="shippingDisplay">RM 0.00</span>
          </div>
          <div class="total-row grand-total">
            <span>Grand Total:</span>
            <span id="grandTotalDisplay">RM 0.00</span>
          </div>
        </div>

        <div class="action-buttons">
          <button id="savePurchaseBtn" class="success-btn" style="flex: 1;">üíæ Save Purchase</button>
          <button id="clearFormBtn" class="secondary-btn">üóëÔ∏è Clear Form</button>
        </div>
      </div>

      <!-- Purchase History Section -->
      <div class="purchase-history-container slide-up">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>üìã Purchase History</h2>
          <button id="refreshPurchasesBtn" class="primary-btn">üîÑ Refresh</button>
        </div>
        
        <div id="purchasesList">
          <!-- Purchase history will be loaded here -->
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3>No Purchases Yet</h3>
            <p>Create your first purchase order to get started</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- JS -->
  <script src="js/setting.js" defer></script>
  <script src="js/script.js" defer></script>
  <script>
    document.documentElement.dataset.page = 'purchase';
    
    let purchaseItems = [];
    let allPurchases = [];
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      initializePurchasePage();
      loadPurchases();
    });
    
    function initializePurchasePage() {
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('purchaseDate').value = today;
      
      // Add first item row
      addItemRow();
      
      // Bind events
      document.getElementById('addItemBtn').addEventListener('click', addItemRow);
      document.getElementById('savePurchaseBtn').addEventListener('click', savePurchase);
      document.getElementById('clearFormBtn').addEventListener('click', clearForm);
      document.getElementById('refreshPurchasesBtn').addEventListener('click', loadPurchases);
      
      // Bind calculation events
      document.getElementById('taxRate').addEventListener('input', calculateTotals);
      document.getElementById('shippingCost').addEventListener('input', calculateTotals);
      
      calculateTotals();
    }
    
    function addItemRow(item = {}) {
      const itemsList = document.getElementById('itemsList');
      const itemId = Date.now() + Math.random();
      
      const itemRow = document.createElement('div');
      itemRow.className = 'item-row fade-in';
      itemRow.innerHTML = `
        <div class="form-group">
          <label>SKU</label>
          <input type="text" class="item-sku" placeholder="Item SKU" value="${item.sku || ''}">
        </div>
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" class="item-name" placeholder="Product name" value="${item.productName || ''}">
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" class="item-quantity" min="1" value="${item.quantity || 1}" step="1">
        </div>
        <div class="form-group">
          <label>Unit Cost (RM)</label>
          <input type="number" class="item-unit-cost" min="0" value="${item.unitCost || 0}" step="0.01">
        </div>
        <div class="item-actions">
          <button type="button" class="danger-btn small-btn" onclick="removeItemRow('${itemId}')">üóëÔ∏è</button>
        </div>
        <div style="grid-column: 1 / -1; text-align: right; padding-top: 10px;">
          <strong>Total: RM <span class="item-total">0.00</span></strong>
        </div>
      `;
      
      itemRow.id = itemId;
      itemsList.appendChild(itemRow);
      
      // Bind calculation events for the new row
      const quantityInput = itemRow.querySelector('.item-quantity');
      const unitCostInput = itemRow.querySelector('.item-unit-cost');
      
      quantityInput.addEventListener('input', () => calculateItemTotal(itemId));
      unitCostInput.addEventListener('input', () => calculateItemTotal(itemId));
      
      // Calculate initial total
      calculateItemTotal(itemId);
    }
    
    function removeItemRow(itemId) {
      const itemRow = document.getElementById(itemId);
      if (itemRow) {
        itemRow.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
          itemRow.remove();
          calculateTotals();
        }, 300);
      }
    }
    
    function calculateItemTotal(itemId) {
      const itemRow = document.getElementById(itemId);
      if (!itemRow) return;
      
      const quantity = parseFloat(itemRow.querySelector('.item-quantity').value) || 0;
      const unitCost = parseFloat(itemRow.querySelector('.item-unit-cost').value) || 0;
      const total = quantity * unitCost;
      
      itemRow.querySelector('.item-total').textContent = total.toFixed(2);
      calculateTotals();
    }
    
    function calculateTotals() {
      let subtotal = 0;
      
      // Calculate subtotal from all items
      document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const unitCost = parseFloat(row.querySelector('.item-unit-cost').value) || 0;
        subtotal += quantity * unitCost;
      });
      
      const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
      const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
      const taxAmount = subtotal * (taxRate / 100);
      const grandTotal = subtotal + taxAmount + shippingCost;
      
      // Update displays
      document.getElementById('subtotalDisplay').textContent = `RM ${subtotal.toFixed(2)}`;
      document.getElementById('taxRateDisplay').textContent = taxRate.toFixed(1);
      document.getElementById('taxAmountDisplay').textContent = `RM ${taxAmount.toFixed(2)}`;
      document.getElementById('shippingDisplay').textContent = `RM ${shippingCost.toFixed(2)}`;
      document.getElementById('grandTotalDisplay').textContent = `RM ${grandTotal.toFixed(2)}`;
    }
    
    function collectPurchaseData() {
      const items = [];
      
      document.querySelectorAll('.item-row').forEach(row => {
        const sku = row.querySelector('.item-sku').value.trim();
        const productName = row.querySelector('.item-name').value.trim();
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const unitCost = parseFloat(row.querySelector('.item-unit-cost').value) || 0;
        
        if (sku && productName && quantity > 0 && unitCost > 0) {
          items.push({
            sku,
            productName,
            quantity,
            unitCost,
            totalCost: quantity * unitCost
          });
        }
      });
      
      if (items.length === 0) {
        alert('Please add at least one valid item to the purchase.');
        return null;
      }
      
      const subtotal = items.reduce((sum, item) => sum + item.totalCost, 0);
      const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
      const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
      const taxAmount = subtotal * (taxRate / 100);
      
      return {
        supplierName: document.getElementById('supplierName').value.trim(),
        supplierAddress: document.getElementById('supplierAddress').value.trim(),
        supplierPhone: document.getElementById('supplierPhone').value.trim(),
        supplierEmail: document.getElementById('supplierEmail').value.trim(),
        purchaseDate: document.getElementById('purchaseDate').value || new Date().toISOString(),
        items,
        subtotal,
        taxRate,
        taxAmount,
        shippingCost,
        totalAmount: subtotal + taxAmount + shippingCost,
        paymentMethod: document.getElementById('paymentMethod').value,
        notes: document.getElementById('notes').value.trim(),
        status: document.getElementById('status').value
      };
    }
    
    async function savePurchase() {
      const purchaseData = collectPurchaseData();
      if (!purchaseData) return;
      
      if (!purchaseData.supplierName) {
        alert('Please enter supplier name.');
        return;
      }
      
      if (!confirm('Confirm saving this purchase order?')) {
        return;
      }
      
      try {
        const response = await apiFetch(`${API_BASE}/purchases`, {
          method: 'POST',
          body: JSON.stringify(purchaseData)
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('‚úÖ Purchase saved successfully!');
          clearForm();
          loadPurchases();
        } else {
          const error = await response.json();
          alert('‚ùå Failed to save purchase: ' + (error.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Save purchase error:', error);
        alert('‚ùå Server error while saving purchase.');
      }
    }
    
    function clearForm() {
      if (!confirm('Clear the entire purchase form?')) return;
      
      document.getElementById('supplierName').value = '';
      document.getElementById('supplierAddress').value = '';
      document.getElementById('supplierPhone').value = '';
      document.getElementById('supplierEmail').value = '';
      document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('notes').value = '';
      document.getElementById('taxRate').value = '6';
      document.getElementById('shippingCost').value = '0';
      document.getElementById('paymentMethod').value = 'Cash';
      document.getElementById('status').value = 'Completed';
      
      // Clear items
      document.getElementById('itemsList').innerHTML = '';
      addItemRow();
      
      calculateTotals();
    }
    
    async function loadPurchases() {
      try {
        const response = await apiFetch(`${API_BASE}/purchases`);
        if (response.ok) {
          allPurchases = await response.json();
          renderPurchases();
        } else {
          console.error('Failed to load purchases');
        }
      } catch (error) {
        console.error('Load purchases error:', error);
      }
    }
    
    function renderPurchases() {
      const purchasesList = document.getElementById('purchasesList');
      
      if (allPurchases.length === 0) {
        purchasesList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3>No Purchases Yet</h3>
            <p>Create your first purchase order to get started</p>
          </div>
        `;
        return;
      }
      
      purchasesList.innerHTML = '';
      
      allPurchases.forEach(purchase => {
        const purchaseCard = document.createElement('div');
        purchaseCard.className = 'purchase-card fade-in';
        purchaseCard.innerHTML = `
          <div class="purchase-header">
            <div>
              <div class="purchase-invoice">${purchase.invoiceNumber}</div>
              <div class="purchase-supplier">${purchase.supplierName}</div>
            </div>
            <div class="purchase-amount">RM ${purchase.totalAmount.toFixed(2)}</div>
          </div>
          
          <div class="purchase-header">
            <div class="purchase-date">
              ${new Date(purchase.purchaseDate).toLocaleDateString()} ‚Ä¢ 
              ${purchase.items.length} item(s)
            </div>
            <span class="status-badge status-${purchase.status.toLowerCase()}">${purchase.status}</span>
          </div>
          
          <div class="purchase-items">
            ${purchase.items.slice(0, 3).map(item => 
              `${item.quantity}x ${item.productName}`
            ).join(', ')}
            ${purchase.items.length > 3 ? `... and ${purchase.items.length - 3} more` : ''}
          </div>
          
          <div class="action-buttons" style="margin-top: 15px;">
            <button class="primary-btn small-btn" onclick="downloadPurchasePDF('${purchase.id}')">
              üìÑ Invoice PDF
            </button>
            <button class="secondary-btn small-btn" onclick="viewPurchaseDetails('${purchase.id}')">
              üëÅÔ∏è Details
            </button>
            <button class="danger-btn small-btn" onclick="deletePurchase('${purchase.id}')">
              üóëÔ∏è Delete
            </button>
          </div>
        `;
        purchasesList.appendChild(purchaseCard);
      });
    }
    
    async function downloadPurchasePDF(purchaseId) {
      try {
        const response = await apiFetch(`${API_BASE}/purchases/report/pdf/${purchaseId}`);
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          
          const contentDisposition = response.headers.get('Content-Disposition');
          const filenameMatch = contentDisposition ? contentDisposition.match(/filename="(.+?)"/) : null;
          const filename = filenameMatch ? filenameMatch[1] : `Purchase_Invoice_${Date.now()}.pdf`;
          
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        } else {
          alert('Failed to generate PDF invoice');
        }
      } catch (error) {
        console.error('PDF download error:', error);
        alert('Error downloading PDF invoice');
      }
    }
    
    function viewPurchaseDetails(purchaseId) {
      const purchase = allPurchases.find(p => p.id === purchaseId);
      if (!purchase) return;
      
      let itemsHtml = '';
      purchase.items.forEach(item => {
        itemsHtml += `
          <tr>
            <td>${item.sku}</td>
            <td>${item.productName}</td>
            <td>${item.quantity}</td>
            <td>RM ${item.unitCost.toFixed(2)}</td>
            <td>RM ${item.totalCost.toFixed(2)}</td>
          </tr>
        `;
      });
      
      const modalHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
          <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2>Purchase Details</h2>
              <button onclick="this.closest('div[style]').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">√ó</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div>
                <h3>Supplier Information</h3>
                <p><strong>Name:</strong> ${purchase.supplierName}</p>
                <p><strong>Address:</strong> ${purchase.supplierAddress || 'N/A'}</p>
                <p><strong>Phone:</strong> ${purchase.supplierPhone || 'N/A'}</p>
                <p><strong>Email:</strong> ${purchase.supplierEmail || 'N/A'}</p>
              </div>
              <div>
                <h3>Purchase Information</h3>
                <p><strong>Invoice:</strong> ${purchase.invoiceNumber}</p>
                <p><strong>Date:</strong> ${new Date(purchase.purchaseDate).toLocaleDateString()}</p>
                <p><strong>Status:</strong> <span class="status-badge status-${purchase.status.toLowerCase()}">${purchase.status}</span></p>
                <p><strong>Payment:</strong> ${purchase.paymentMethod}</p>
              </div>
            </div>
            
            <h3>Items</h3>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #2c5aa0; color: white;">
                    <th style="padding: 10px; text-align: left;">SKU</th>
                    <th style="padding: 10px; text-align: left;">Product</th>
                    <th style="padding: 10px; text-align: center;">Qty</th>
                    <th style="padding: 10px; text-align: right;">Unit Cost</th>
                    <th style="padding: 10px; text-align: right;">Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${itemsHtml}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
              <div><strong>Subtotal:</strong> RM ${purchase.subtotal.toFixed(2)}</div>
              <div><strong>Tax (${purchase.taxRate}%):</strong> RM ${purchase.taxAmount.toFixed(2)}</div>
              <div><strong>Shipping:</strong> RM ${purchase.shippingCost.toFixed(2)}</div>
              <div style="font-size: 1.2em; font-weight: bold; border-top: 2px solid #ccc; padding-top: 5px;">
                <strong>Grand Total:</strong> RM ${purchase.totalAmount.toFixed(2)}
              </div>
            </div>
            
            ${purchase.notes ? `<div style="margin-top: 20px;"><strong>Notes:</strong> ${purchase.notes}</div>` : ''}
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function deletePurchase(purchaseId) {
      const purchase = allPurchases.find(p => p.id === purchaseId);
      if (!purchase) return;
      
      if (!confirm(`Delete purchase ${purchase.invoiceNumber}? This action cannot be undone.`)) {
        return;
      }
      
      try {
        const response = await apiFetch(`${API_BASE}/purchases/${purchaseId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('‚úÖ Purchase deleted successfully!');
          loadPurchases();
        } else {
          alert('‚ùå Failed to delete purchase');
        }
      } catch (error) {
        console.error('Delete purchase error:', error);
        alert('‚ùå Server error while deleting purchase');
      }
    }
  </script>
</body>
</html>
