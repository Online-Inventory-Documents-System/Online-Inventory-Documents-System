<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Purchase | Inventory System</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .modal { position: fixed; left:0; right:0; top:0; bottom:0; display:none; background: rgba(0,0,0,0.45); z-index: 9999; }
    .modal-inner { margin: 40px auto; max-width: 820px; background: var(--card-light); padding: 18px; border-radius: 8px; }
    .search-dropdown { position: relative; }
    .search-dropdown-list { position:absolute; left:0; right:0; background:white; max-height:220px; overflow:auto; border:1px solid #ddd; z-index:50; display:none; }
    .search-dropdown-item { padding:8px; cursor:pointer; border-bottom:1px solid #eee; }
    .search-dropdown-item:hover { background:#f1f1f1; }
    .purchase-item-row input { padding:8px; border:1px solid var(--border-color); border-radius:6px; }
    .purchase-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .purchase-form .full-width { grid-column: 1 / -1; }
    .print-btn { background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    .print-btn:hover { background: #218838; }
    .purchase-summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--primary-color); }
    .loading-message { text-align: center; padding: 20px; color: #666; }
  </style>
</head>
<body>
  <header>
    <h1>üßæ Purchase Management</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="inventory.html">Inventory</a>
      <a href="purchase.html">Purchase</a>
      <a href="documents.html">Documents</a>
      <a href="log.html">Activity Log</a>
      <a href="setting.html" style="text-decoration:none;"><button>‚öôÔ∏è Setting</button></a>
      <button onclick="toggleTheme()">üåì Mode</button>
      <button onclick="logout()">üö™ Logout</button>
      <div id="adminInfo">Logged in as: <span id="adminName"></span></div>
    </nav>
  </header>

  <main>
    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Purchase Records</h2>
        <div style="display:flex;gap:8px;">
          <button id="downloadPurchasePDFBtn" class="secondary-btn">üìä Total Purchase Report</button>
          <button id="addPurchaseBtn" class="primary-btn">‚ûï Create Purchase</button>
        </div>
      </div>

      <!-- Purchase Summary Cards -->
      <div class="summary-cards">
        <div class="card card-total-value">
          <div class="card-icon">üí∞</div>
          <div class="card-content">
            <div class="card-title">Total Purchases</div>
            <div class="card-value" id="totalPurchases">0</div>
            <div class="card-wave"></div>
          </div>
        </div>
        
        <div class="card card-total-revenue">
          <div class="card-icon">üì¶</div>
          <div class="card-content">
            <div class="card-title">Total Items</div>
            <div class="card-value" id="totalItems">0</div>
            <div class="card-wave"></div>
          </div>
        </div>
        
        <div class="card card-total-profit">
          <div class="card-icon">üí∏</div>
          <div class="card-content">
            <div class="card-title">Total Amount</div>
            <div class="card-value" id="totalAmount">RM 0.00</div>
            <div class="card-wave"></div>
          </div>
        </div>
        
        <div class="card card-total-stock">
          <div class="card-icon">üè¢</div>
          <div class="card-content">
            <div class="card-title">Suppliers</div>
            <div class="card-value" id="totalSuppliers">0</div>
            <div class="card-wave"></div>
          </div>
        </div>
      </div>

      <div class="table-container" style="margin-top:12px;">
        <table id="purchaseTable">
          <thead>
            <tr>
              <th>Purchase #</th>
              <th>SKU</th>
              <th>Product Name</th>
              <th>Supplier</th>
              <th>Quantity</th>
              <th class="money">Unit Price</th>
              <th class="money">Total</th>
              <th>Date</th>
              <th class="actions">Actions</th>
            </tr>
          </thead>
          <tbody id="purchaseList">
            <tr>
              <td colspan="9" class="loading-message">Loading purchase data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Add Purchase Modal -->
  <div id="purchaseModal" class="modal">
    <div class="modal-inner">
      <h2>Create New Purchase</h2>
      
      <div class="purchase-form">
        <div class="full-width">
          <label>Search Product:</label>
          <div class="search-dropdown">
            <input type="text" id="productSearch" placeholder="Type to search products by SKU or name..." />
            <div class="search-dropdown-list" id="productDropdown">
              <div class="search-dropdown-item" style="color:#999;">Start typing to search products...</div>
            </div>
          </div>
        </div>
        
        <div>
          <label>SKU:</label>
          <input type="text" id="purchaseSku" readonly />
        </div>
        
        <div>
          <label>Product Name:</label>
          <input type="text" id="purchaseName" readonly />
        </div>
        
        <div>
          <label>Supplier:</label>
          <input type="text" id="purchaseSupplier" placeholder="Enter supplier name" />
        </div>
        
        <div>
          <label>Quantity:</label>
          <input type="number" id="purchaseQuantity" min="1" value="1" />
        </div>
        
        <div>
          <label>Unit Price (RM):</label>
          <input type="number" id="purchasePrice" step="0.01" min="0" placeholder="0.00" />
        </div>
        
        <div>
          <label>Purchase Date:</label>
          <input type="date" id="purchaseDate" />
        </div>
      </div>

      <div id="purchaseSummary" class="purchase-summary" style="display:none;">
        <h4>Purchase Summary</h4>
        <div id="summaryDetails"></div>
      </div>
      
      <div style="display:flex;gap:10px;margin-top:20px;">
        <button id="savePurchaseBtn" class="primary-btn">üíæ Save Purchase</button>
        <button id="cancelPurchaseBtn" class="secondary-btn">‚ùå Cancel</button>
      </div>
      
      <div id="printSection" style="display:none;margin-top:20px;text-align:center;">
        <button id="printInvoiceBtn" class="print-btn">üñ®Ô∏è Print Purchase Invoice</button>
      </div>
    </div>
  </div>

  <script src="js/setting.js" defer></script>
  <script src="js/script.js" defer></script>
  <script>
    document.documentElement.dataset.page = 'purchase';
    
    // Global variables for purchase management
    let purchases = [];
    let inventoryProducts = [];
    let currentPurchaseId = null;
    let isInventoryLoaded = false;

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', async () => {
      await initializePurchasePage();
    });

    async function initializePurchasePage() {
      console.log('üîÑ Initializing purchase page...');
      
      // Update admin name
      const adminName = getUsername();
      if(document.getElementById('adminName')) {
        document.getElementById('adminName').textContent = adminName;
      }

      // Load purchases and inventory
      await loadPurchases();
      await loadInventoryProducts();
      
      // Bind event listeners
      bindPurchaseUI();
      
      console.log('‚úÖ Purchase page initialized');
    }

    async function loadPurchases() {
      try {
        console.log('üì¶ Loading purchases...');
        const res = await apiFetch(`${API_BASE}/purchases`);
        if(res.ok) {
          purchases = await res.json();
          renderPurchases();
          updatePurchaseSummaryCards();
          console.log('‚úÖ Purchases loaded:', purchases.length);
        } else {
          console.error('‚ùå Failed to load purchases');
        }
      } catch(err) {
        console.error('‚ùå Error loading purchases:', err);
      }
    }

    async function loadInventoryProducts() {
      try {
        console.log('üì¶ Loading inventory products...');
        const products = await fetchInventoryForPurchase();
        if (products && Array.isArray(products)) {
          inventoryProducts = products;
          isInventoryLoaded = true;
          console.log('‚úÖ Inventory products loaded:', inventoryProducts.length);
        } else {
          console.error('‚ùå No products returned from inventory');
          inventoryProducts = [];
        }
      } catch(err) {
        console.error('‚ùå Error loading inventory products:', err);
        inventoryProducts = [];
      }
    }

    function bindPurchaseUI() {
      // Add purchase button
      document.getElementById('addPurchaseBtn').addEventListener('click', openPurchaseModal);
      
      // Download report button
      document.getElementById('downloadPurchasePDFBtn').addEventListener('click', generatePurchaseReport);
      
      // Modal buttons
      document.getElementById('savePurchaseBtn').addEventListener('click', savePurchase);
      document.getElementById('cancelPurchaseBtn').addEventListener('click', closePurchaseModal);
      document.getElementById('printInvoiceBtn').addEventListener('click', printPurchaseInvoice);
      
      // Product search functionality
      document.getElementById('productSearch').addEventListener('input', searchProducts);
      
      // Update summary when quantity or price changes
      document.getElementById('purchaseQuantity').addEventListener('input', updatePurchaseSummary);
      document.getElementById('purchasePrice').addEventListener('input', updatePurchaseSummary);
    }

    function openPurchaseModal() {
      if (!isInventoryLoaded) {
        alert('‚ö†Ô∏è Inventory data is still loading. Please wait a moment and try again.');
        return;
      }
      
      document.getElementById('purchaseModal').style.display = 'block';
      document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('printSection').style.display = 'none';
      document.getElementById('purchaseSummary').style.display = 'none';
      clearPurchaseForm();
    }

    function closePurchaseModal() {
      document.getElementById('purchaseModal').style.display = 'none';
      clearPurchaseForm();
    }

    function clearPurchaseForm() {
      document.getElementById('productSearch').value = '';
      document.getElementById('purchaseSku').value = '';
      document.getElementById('purchaseName').value = '';
      document.getElementById('purchaseSupplier').value = '';
      document.getElementById('purchaseQuantity').value = '1';
      document.getElementById('purchasePrice').value = '';
      document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('productDropdown').style.display = 'none';
    }

    function updatePurchaseSummary() {
      const quantity = Number(document.getElementById('purchaseQuantity').value) || 0;
      const price = Number(document.getElementById('purchasePrice').value) || 0;
      const total = quantity * price;
      
      if (quantity > 0 && price > 0) {
        document.getElementById('purchaseSummary').style.display = 'block';
        document.getElementById('summaryDetails').innerHTML = `
          <p>Quantity: ${quantity} units</p>
          <p>Unit Price: RM ${price.toFixed(2)}</p>
          <p><strong>Total: RM ${total.toFixed(2)}</strong></p>
        `;
      } else {
        document.getElementById('purchaseSummary').style.display = 'none';
      }
    }

    function renderPurchases() {
      const list = document.getElementById('purchaseList');
      if(!list) return;
      
      list.innerHTML = '';
      
      if (purchases.length === 0) {
        list.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;">No purchase records found</td></tr>';
        return;
      }
      
      purchases.forEach(purchase => {
        const total = purchase.quantity * purchase.purchasePrice;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(purchase.purchaseNumber || '')}</td>
          <td>${escapeHtml(purchase.sku || '')}</td>
          <td>${escapeHtml(purchase.productName || '')}</td>
          <td>${escapeHtml(purchase.supplier || '')}</td>
          <td>${purchase.quantity}</td>
          <td class="money">RM ${Number(purchase.purchasePrice || 0).toFixed(2)}</td>
          <td class="money">RM ${total.toFixed(2)}</td>
          <td>${new Date(purchase.date).toLocaleDateString()}</td>
          <td class="actions">
            <button class="primary-btn small-btn" onclick="editPurchase('${purchase.id}')">‚úèÔ∏è Edit</button>
            <button class="danger-btn small-btn" onclick="deletePurchase('${purchase.id}')">üóëÔ∏è Delete</button>
            <button class="success-btn small-btn" onclick="printSingleInvoice('${purchase.id}')">üñ®Ô∏è Invoice</button>
          </td>
        `;
        list.appendChild(tr);
      });
    }

    function updatePurchaseSummaryCards() {
      const totalPurchases = purchases.length;
      const totalItems = purchases.reduce((sum, p) => sum + (p.quantity || 0), 0);
      const totalAmount = purchases.reduce((sum, p) => sum + (p.quantity * p.purchasePrice || 0), 0);
      const uniqueSuppliers = new Set(purchases.map(p => p.supplier)).size;
      
      document.getElementById('totalPurchases').textContent = totalPurchases;
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalAmount').textContent = `RM ${totalAmount.toFixed(2)}`;
      document.getElementById('totalSuppliers').textContent = uniqueSuppliers;
    }

    function searchProducts() {
      const query = document.getElementById('productSearch').value.toLowerCase().trim();
      const dropdown = document.getElementById('productDropdown');
      
      if (!isInventoryLoaded) {
        dropdown.innerHTML = '<div class="search-dropdown-item" style="color:#999;">Inventory still loading...</div>';
        dropdown.style.display = 'block';
        return;
      }
      
      if (query.length < 1) {
        dropdown.innerHTML = '<div class="search-dropdown-item" style="color:#999;">Start typing to search products...</div>';
        dropdown.style.display = 'block';
        return;
      }
      
      const filteredProducts = inventoryProducts.filter(product => {
        const skuMatch = product.sku && product.sku.toLowerCase().includes(query);
        const nameMatch = product.name && product.name.toLowerCase().includes(query);
        return skuMatch || nameMatch;
      });
      
      dropdown.innerHTML = '';
      
      if (filteredProducts.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'search-dropdown-item';
        noResult.textContent = 'No products found';
        noResult.style.color = '#999';
        dropdown.appendChild(noResult);
      } else {
        filteredProducts.forEach(product => {
          const div = document.createElement('div');
          div.className = 'search-dropdown-item';
          div.innerHTML = `
            <strong>${product.sku || 'No SKU'}</strong> - ${product.name || 'No Name'}
            <br><small>Category: ${product.category || 'N/A'} | Stock: ${product.quantity || 0}</small>
          `;
          div.addEventListener('click', () => selectProduct(product));
          dropdown.appendChild(div);
        });
      }
      
      dropdown.style.display = 'block';
    }

    function selectProduct(product) {
      document.getElementById('productSearch').value = `${product.sku || ''} - ${product.name || ''}`;
      document.getElementById('purchaseSku').value = product.sku || '';
      document.getElementById('purchaseName').value = product.name || '';
      document.getElementById('productDropdown').style.display = 'none';
      
      // Set the purchase price to the current unit cost as default
      if(product.unitCost) {
        document.getElementById('purchasePrice').value = Number(product.unitCost).toFixed(2);
      } else {
        document.getElementById('purchasePrice').value = '';
      }
      
      // Update summary
      updatePurchaseSummary();
    }

    async function savePurchase() {
      const sku = document.getElementById('purchaseSku').value.trim();
      const productName = document.getElementById('purchaseName').value.trim();
      const supplier = document.getElementById('purchaseSupplier').value.trim();
      const quantity = Number(document.getElementById('purchaseQuantity').value);
      const purchasePrice = Number(document.getElementById('purchasePrice').value);
      const date = document.getElementById('purchaseDate').value;
      
      if(!sku || !productName || !supplier || quantity <= 0 || purchasePrice <= 0) {
        alert('‚ö†Ô∏è Please fill in all fields with valid values.');
        return;
      }
      
      const purchaseData = {
        sku,
        productName,
        supplier,
        quantity,
        purchasePrice,
        date
      };
      
      try {
        const res = await apiFetch(`${API_BASE}/purchases`, {
          method: 'POST',
          body: JSON.stringify(purchaseData)
        });
        
        if(res.ok) {
          const newPurchase = await res.json();
          currentPurchaseId = newPurchase.id;
          await loadPurchases();
          document.getElementById('printSection').style.display = 'block';
          alert('‚úÖ Purchase saved successfully! Inventory updated.');
        } else {
          const error = await res.json();
          alert('‚ùå Failed to save purchase: ' + (error.message || 'Unknown error'));
        }
      } catch(err) {
        console.error('Error saving purchase:', err);
        alert('‚ùå Server error while saving purchase.');
      }
    }

    async function generatePurchaseReport() {
      if(purchases.length === 0) {
        alert('No purchase records to generate report.');
        return;
      }
      
      if(!confirm('Generate Total Purchase Report?')) return;
      
      try {
        const res = await apiFetch(`${API_BASE}/purchases/report/pdf`);
        if(res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Purchase_Report_${new Date().toISOString().slice(0,10)}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        } else {
          alert('‚ùå Failed to generate purchase report.');
        }
      } catch(err) {
        console.error('Error generating report:', err);
        alert('‚ùå Server error while generating report.');
      }
    }

    async function printPurchaseInvoice() {
      if(!currentPurchaseId) {
        alert('No purchase selected for printing.');
        return;
      }
      
      await printSingleInvoice(currentPurchaseId);
    }

    async function printSingleInvoice(purchaseId) {
      try {
        const res = await apiFetch(`${API_BASE}/purchases/${purchaseId}/invoice`);
        if(res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          
          const purchase = purchases.find(p => p.id === purchaseId);
          const filename = purchase ? `Invoice_${purchase.purchaseNumber}.pdf` : `Purchase_Invoice_${Date.now()}.pdf`;
          a.download = filename;
          
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        } else {
          alert('‚ùå Failed to generate invoice.');
        }
      } catch(err) {
        console.error('Error generating invoice:', err);
        alert('‚ùå Server error while generating invoice.');
      }
    }

    async function editPurchase(id) {
      const purchase = purchases.find(p => p.id === id);
      if(!purchase) return;
      
      document.getElementById('purchaseModal').style.display = 'block';
      document.getElementById('purchaseSku').value = purchase.sku;
      document.getElementById('purchaseName').value = purchase.productName;
      document.getElementById('purchaseSupplier').value = purchase.supplier;
      document.getElementById('purchaseQuantity').value = purchase.quantity;
      document.getElementById('purchasePrice').value = purchase.purchasePrice;
      document.getElementById('purchaseDate').value = purchase.date.split('T')[0];
      document.getElementById('productSearch').value = `${purchase.sku} - ${purchase.productName}`;
      
      currentPurchaseId = id;
      document.getElementById('printSection').style.display = 'block';
      updatePurchaseSummary();
    }

    async function deletePurchase(id) {
      const purchase = purchases.find(p => p.id === id);
      if(!purchase) return;
      
      if(!confirm(`Are you sure you want to delete purchase ${purchase.purchaseNumber} for ${purchase.productName}?`)) return;
      
      try {
        const res = await apiFetch(`${API_BASE}/purchases/${id}`, {
          method: 'DELETE'
        });
        
        if(res.ok) {
          await loadPurchases();
          alert('üóëÔ∏è Purchase deleted successfully!');
        } else {
          alert('‚ùå Failed to delete purchase.');
        }
      } catch(err) {
        console.error('Error deleting purchase:', err);
        alert('‚ùå Server error while deleting purchase.');
      }
    }

    // Utility functions
    function getUsername() {
      return sessionStorage.getItem('adminName') || 'Guest';
    }

    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;', 
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Expose functions to global scope
    window.openPurchaseModal = openPurchaseModal;
    window.closePurchaseModal = closePurchaseModal;
    window.savePurchase = savePurchase;
    window.printPurchaseInvoice = printPurchaseInvoice;
    window.editPurchase = editPurchase;
    window.deletePurchase = deletePurchase;
    window.generatePurchaseReport = generatePurchaseReport;
    window.printSingleInvoice = printSingleInvoice;
    window.toggleTheme = toggleTheme;
    window.logout = logout;
  </script>
</body>
</html>
