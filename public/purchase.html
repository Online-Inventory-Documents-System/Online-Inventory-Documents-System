<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Purchase Orders | Inventory System</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>üõí Purchase Management</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="inventory.html">Inventory</a>
      <a href="purchase.html">Purchase</a>
      <a href="documents.html">Documents</a>
      <a href="log.html">Activity Log</a>
      <a href="setting.html" style="text-decoration: none;"><button>‚öôÔ∏è Setting</button></a>
      <button onclick="toggleTheme()">üåì Mode</button>
      <button onclick="logout()">üö™ Logout</button>
      <div id="adminInfo">Logged in as: <span id="adminName"></span></div>
    </nav>
  </header>

  <div class="purchase-container">
    <h2>Add New Purchase Order</h2>
    
    <div class="purchase-form">
      <div class="form-group">
        <label for="customerName">Customer Name</label>
        <input type="text" id="customerName" placeholder="Enter customer name" />
      </div>
      
      <div class="form-group">
        <label for="customerPhone">Customer Phone</label>
        <input type="text" id="customerPhone" placeholder="Enter customer phone" />
      </div>
      
      <div class="form-group full-width">
        <label for="customerAddress">Customer Address</label>
        <input type="text" id="customerAddress" placeholder="Enter customer address" />
      </div>
    </div>

    <h3>Products</h3>
    <button class="add-item-btn" onclick="addNewItem()">+ Add Product</button>
    
    <table class="items-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>SKU</th>
          <th>Current Stock</th>
          <th>Purchase Qty</th>
          <th>Rate (RM)</th>
          <th>Amount (RM)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="itemsTableBody">
        <!-- Items will be added here dynamically -->
      </tbody>
    </table>

    <div class="calculation-section">
      <div class="calculation-row">
        <span>Total Amount: </span>
        <span id="totalAmount">RM 0.00</span>
      </div>
    </div>

    <div class="action-buttons">
      <button class="success-btn" onclick="createPurchaseOrder()">Create Order</button>
      <button class="primary-btn" onclick="generatePurchasePDF()" id="pdfBtn" disabled>Generate PDF Invoice</button>
      <button class="secondary-btn" onclick="showTransactionHistory()">Transaction History</button>
      <button class="danger-btn" onclick="goBack()">Back</button>
    </div>

    <div class="history-section" id="historySection" style="display: none;">
      <h3>Purchase Transaction History</h3>
      <div class="table-container">
        <table class="history-table">
          <thead>
            <tr>
              <th>Purchase ID</th>
              <th>Customer Name</th>
              <th>Date</th>
              <th>Total Amount</th>
              <th>Items Count</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="purchaseHistory">
            <!-- Purchase history will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="js/setting.js" defer></script>
  <script src="js/script.js" defer></script>
  <script>
    document.documentElement.dataset.page = 'purchase';
    let currentPurchaseId = null;
    let inventoryItems = [];

    // Load inventory items for dropdown
    async function loadInventoryItems() {
      try {
        const response = await fetch(`${window.API_BASE}/inventory`, {
          headers: {
            'X-Username': window.getUsername()
          }
        });
        
        if (response.ok) {
          inventoryItems = await response.json();
          console.log('Loaded inventory items:', inventoryItems.length);
        }
      } catch (error) {
        console.error('Error loading inventory:', error);
      }
    }

    function addNewItem() {
      const tableBody = document.getElementById('itemsTableBody');
      const row = document.createElement('tr');
      const rowId = Date.now();
      
      // Create product options HTML
      const productOptions = inventoryItems.map(item => 
        `<option value="${item.id}" data-sku="${item.sku || ''}" data-stock="${item.quantity || 0}" data-price="${item.unitPrice || 0}">
          ${item.name} (${item.sku || 'No SKU'})
        </option>`
      ).join('');
      
      row.innerHTML = `
        <td>
          <select class="product-select" onchange="onProductChange(${rowId}, this.value)">
            <option value="">Select Product</option>
            ${productOptions}
          </select>
        </td>
        <td><span class="sku-display">-</span></td>
        <td><span class="stock-display">-</span></td>
        <td><input type="number" class="quantity" value="1" min="1" onchange="calculateItemAmount(${rowId})"></td>
        <td><input type="number" class="rate" value="0" min="0" step="0.01" onchange="calculateItemAmount(${rowId})"></td>
        <td><span class="amount">0.00</span></td>
        <td><button class="delete-item-btn" onclick="deleteItem(${rowId})">Delete</button></td>
      `;
      
      row.id = `item-${rowId}`;
      tableBody.appendChild(row);
      calculateTotalAmount();
    }

    function onProductChange(rowId, productId) {
      const row = document.getElementById(`item-${rowId}`);
      const product = inventoryItems.find(item => item.id === productId);
      
      if (product) {
        row.querySelector('.sku-display').textContent = product.sku || 'N/A';
        row.querySelector('.stock-display').textContent = product.quantity || 0;
        row.querySelector('.rate').value = product.unitPrice || 0;
        calculateItemAmount(rowId);
      } else {
        row.querySelector('.sku-display').textContent = '-';
        row.querySelector('.stock-display').textContent = '-';
        row.querySelector('.rate').value = 0;
        calculateItemAmount(rowId);
      }
    }

    function calculateItemAmount(rowId) {
      const row = document.getElementById(`item-${rowId}`);
      const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
      const rate = parseFloat(row.querySelector('.rate').value) || 0;
      const amount = quantity * rate;
      
      row.querySelector('.amount').textContent = amount.toFixed(2);
      calculateTotalAmount();
    }

    function deleteItem(rowId) {
      const row = document.getElementById(`item-${rowId}`);
      row.remove();
      calculateTotalAmount();
    }

    function calculateTotalAmount() {
      let totalAmount = 0;
      
      document.querySelectorAll('#itemsTableBody tr').forEach(row => {
        const amount = parseFloat(row.querySelector('.amount').textContent) || 0;
        totalAmount += amount;
      });
      
      document.getElementById('totalAmount').textContent = `RM ${totalAmount.toFixed(2)}`;
    }

    async function createPurchaseOrder() {
      const customerName = document.getElementById('customerName').value;
      const customerAddress = document.getElementById('customerAddress').value;
      const customerPhone = document.getElementById('customerPhone').value;
      
      if (!customerName || !customerAddress || !customerPhone) {
        alert('Please fill in all customer details');
        return;
      }

      // Collect items
      const items = [];
      let hasErrors = false;

      document.querySelectorAll('#itemsTableBody tr').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const productId = productSelect.value;
        const productName = productSelect.options[productSelect.selectedIndex]?.text.split(' (')[0] || '';
        const sku = row.querySelector('.sku-display').textContent;
        const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
        const rate = parseFloat(row.querySelector('.rate').value) || 0;
        const amount = parseFloat(row.querySelector('.amount').textContent) || 0;
        
        if (!productId) {
          alert('Please select a product for all items');
          hasErrors = true;
          return;
        }

        if (quantity <= 0) {
          alert('Please enter a valid quantity greater than 0');
          hasErrors = true;
          return;
        }

        items.push({
          productId,
          productName,
          sku,
          quantity,
          rate,
          amount
        });
      });

      if (hasErrors) return;

      if (items.length === 0) {
        alert('Please add at least one product');
        return;
      }

      const totalAmount = parseFloat(document.getElementById('totalAmount').textContent.replace('RM ', '')) || 0;

      const purchaseData = {
        customerName,
        customerAddress,
        customerPhone,
        items,
        totalAmount
      };

      try {
        const response = await fetch(`${window.API_BASE}/purchases`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Username': window.getUsername()
          },
          body: JSON.stringify(purchaseData)
        });

        if (response.ok) {
          const result = await response.json();
          currentPurchaseId = result.id;
          document.getElementById('pdfBtn').disabled = false;
          alert('Purchase order created successfully! Inventory updated.');
          // Refresh inventory and clear form
          await loadInventoryItems();
          resetForm();
        } else {
          const error = await response.json();
          alert('Error creating purchase order: ' + error.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error creating purchase order');
      }
    }

    function resetForm() {
      document.getElementById('customerName').value = '';
      document.getElementById('customerAddress').value = '';
      document.getElementById('customerPhone').value = '';
      document.getElementById('itemsTableBody').innerHTML = '';
      document.getElementById('totalAmount').textContent = 'RM 0.00';
      currentPurchaseId = null;
      document.getElementById('pdfBtn').disabled = true;
      // Add one empty row
      addNewItem();
    }

    async function generatePurchasePDF() {
      if (!currentPurchaseId) {
        alert('Please create a purchase order first');
        return;
      }

      try {
        const response = await fetch(`${window.API_BASE}/purchases/report/pdf/${currentPurchaseId}`, {
          headers: {
            'X-Username': window.getUsername()
          }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Purchase_Invoice_${currentPurchaseId}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        } else {
          alert('Error generating PDF');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error generating PDF');
      }
    }

    async function showTransactionHistory() {
      const historySection = document.getElementById('historySection');
      const isVisible = historySection.style.display === 'block';
      
      if (!isVisible) {
        await loadPurchaseHistory();
        historySection.style.display = 'block';
      } else {
        historySection.style.display = 'none';
      }
    }

    async function loadPurchaseHistory() {
      try {
        const response = await fetch(`${window.API_BASE}/purchases`, {
          headers: {
            'X-Username': window.getUsername()
          }
        });

        if (response.ok) {
          const purchases = await response.json();
          const historyBody = document.getElementById('purchaseHistory');
          historyBody.innerHTML = '';

          purchases.forEach(purchase => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${purchase.purchaseId}</td>
              <td>${purchase.customerName}</td>
              <td>${new Date(purchase.date).toLocaleDateString()}</td>
              <td>RM ${purchase.totalAmount.toFixed(2)}</td>
              <td>${purchase.items.length} items</td>
              <td>
                <button class="primary-btn small-btn" onclick="viewPurchase('${purchase.id}')">View</button>
                <button class="success-btn small-btn" onclick="downloadPurchasePDF('${purchase.id}')">PDF</button>
              </td>
            `;
            historyBody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading purchase history:', error);
      }
    }

    async function downloadPurchasePDF(purchaseId) {
      try {
        const response = await fetch(`${window.API_BASE}/purchases/report/pdf/${purchaseId}`, {
          headers: {
            'X-Username': window.getUsername()
          }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Purchase_Invoice_${purchaseId}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        }
      } catch (error) {
        console.error('Error downloading PDF:', error);
        alert('Error downloading PDF');
      }
    }

    function viewPurchase(purchaseId) {
      // You can implement a detailed view modal here
      alert('View purchase details for ID: ' + purchaseId);
    }

    function goBack() {
      window.location.href = 'index.html';
    }

    // Initialize when page loads
    window.addEventListener('load', async () => {
      await loadInventoryItems();
      addNewItem(); // Start with one empty item
    });

    // Expose functions to global scope
    window.addNewItem = addNewItem;
    window.onProductChange = onProductChange;
    window.calculateItemAmount = calculateItemAmount;
    window.deleteItem = deleteItem;
    window.calculateTotalAmount = calculateTotalAmount;
    window.createPurchaseOrder = createPurchaseOrder;
    window.generatePurchasePDF = generatePurchasePDF;
    window.showTransactionHistory = showTransactionHistory;
    window.loadPurchaseHistory = loadPurchaseHistory;
    window.downloadPurchasePDF = downloadPurchasePDF;
    window.viewPurchase = viewPurchase;
    window.goBack = goBack;
  </script>
</body>
</html>
