<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Sales | Inventory System</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>‚úèÔ∏è Edit Sales Order</h1>
     <nav>
      <a href="index.html">Dashboard</a>
      <a href="documents.html">Documents</a>
      <a href="log.html">Activity Log</a>
      <a href="setting.html" style="text-decoration: none;"><button>‚öôÔ∏è Setting</button></a>
      <button onclick="toggleTheme()">üåì Mode</button>
      <button onclick="logout()">üö™ Logout</button>
      <div id="adminInfo">Logged in as: <span id="adminName"></span></div>
    </nav>
  </header>


  <section>
    <div id="loadingMessage">Loading sales details...</div>
    
    <div id="salesForm" style="display: none;">
      <div class="form-row">
        <div class="form-group">
          <label for="editCustomerName">Customer Name:</label>
          <input type="text" id="editCustomerName" placeholder="Enter customer name">
        </div>
        <div class="form-group">
          <label for="editSalesDate">Sales Date:</label>
          <input type="date" id="editSalesDate">
        </div>
      </div>

      <div class="form-group">
        <label for="editSalesNotes">Notes (Optional):</label>
        <textarea id="editSalesNotes" placeholder="Any additional notes..." rows="3"></textarea>
      </div>

      <h3>Sales Items</h3>
      <div class="search-product-section">
        <input type="text" id="productSearchSales" placeholder="Search by SKU or product name..." class="search-input">
        <div id="productResultsSales" class="product-results"></div>
      </div>

      <div class="sales-items-container">
        <div id="editSalesItems">
          <!-- Dynamic edit sales items will be added here -->
        </div>
        <button id="addEditSalesProductItem" class="primary-btn" style="margin-top: 10px;">+ Add Product Item</button>
      </div>

      <div class="sales-summary">
        <div class="total-amount-display">
          <strong>Total Amount: RM <span id="editTotalSalesAmount">0.00</span></strong>
        </div>
      </div>

      <div class="form-actions" style="display: flex; gap: 10px; margin-top: 25px;">
        <button id="updateSalesBtn" class="primary-btn">üíæ Update Sales Order</button>
        <button id="printSalesInvoiceBtn" class="success-btn">üñ®Ô∏è Print Invoice</button>
        <button id="cancelEditBtn" class="secondary-btn">‚úñÔ∏è Cancel</button>
        <button id="deleteSalesBtn" class="danger-btn">üóëÔ∏è Delete Sales</button>
      </div>
    </div>

    <div id="errorMessage" style="display: none; color: red; text-align: center; padding: 20px;">
      Failed to load sales details. Please try again.
    </div>
  </section>

  <!-- JS -->
  <script src="js/setting.js" defer></script>
  <script src="js/script.js" defer></script>
  <script>
    document.documentElement.dataset.page = 'sales-edit';
    
    // Sales edit page specific functionality
    let currentSalesId = null;
    
    async function loadSalesDetails() {
      const params = new URLSearchParams(window.location.search);
      currentSalesId = params.get('id');
      
      if (!currentSalesId) {
        showError('No sales ID provided');
        return;
      }
      
      try {
        const res = await apiFetch(`${API_BASE}/sales/${currentSalesId}`);
        if (!res.ok) throw new Error('Failed to fetch sales details');
        
        const sales = await res.json();
        
        // Populate form
        qs('#editCustomerName').value = sales.customer || '';
        qs('#editSalesDate').value = sales.salesDate ? new Date(sales.salesDate).toISOString().split('T')[0] : '';
        qs('#editSalesNotes').value = sales.notes || '';
        
        // Clear existing items
        qs('#editSalesItems').innerHTML = '';
        
        // Add items
        sales.items.forEach(item => {
          addEditSalesProductItem(item);
        });
        
        // Update total
        updateSalesTotalAmount();
        
        // Load product search
        loadProductSearchForSales();
        
        // Show form, hide loading
        qs('#loadingMessage').style.display = 'none';
        qs('#salesForm').style.display = 'block';
        
      } catch (e) {
        console.error('Load sales error:', e);
        qs('#loadingMessage').style.display = 'none';
        showError('Failed to load sales details: ' + e.message);
      }
    }
    
    function showError(message) {
      qs('#errorMessage').textContent = message;
      qs('#errorMessage').style.display = 'block';
    }
    
    function addEditSalesProductItem(product = null) {
      const container = qs('#editSalesItems');
      const itemId = `edit-sales-item-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
      
      const itemRow = document.createElement('div');
      itemRow.className = 'sales-item-row';
      itemRow.id = itemId;
      
      const inventoryItem = inventory.find(item => item.sku === product?.sku);
      const availableStock = inventoryItem ? inventoryItem.quantity : 0;
      
      itemRow.innerHTML = `
        <div class="form-group">
          <label>SKU</label>
          <input type="text" class="product-sku" placeholder="SKU" value="${product ? escapeHtml(product.sku || '') : ''}">
        </div>
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" class="product-name" placeholder="Product Name" value="${product ? escapeHtml(product.productName || '') : ''}">
        </div>
        <div class="form-group">
          <label>Quantity (Stock: ${availableStock})</label>
          <input type="number" class="product-quantity" placeholder="Qty" min="1" max="${availableStock}" value="${product ? product.quantity : '1'}">
        </div>
        <div class="form-group">
          <label>Sale Price (RM)</label>
          <input type="number" class="product-price" placeholder="Price" step="0.01" min="0" value="${product ? product.salePrice : '0.00'}">
        </div>
        <div class="form-group">
          <label>Total (RM)</label>
          <input type="text" class="product-total" placeholder="Total" readonly value="${product ? product.totalAmount.toFixed(2) : '0.00'}">
        </div>
        <button class="danger-btn remove-item-btn" type="button" title="Remove Item">üóëÔ∏è</button>
      `;
      
      container.appendChild(itemRow);
      
      // Add event listeners for the new row
      const quantityInput = itemRow.querySelector('.product-quantity');
      const priceInput = itemRow.querySelector('.product-price');
      const totalInput = itemRow.querySelector('.product-total');
      
      const calculateTotal = () => {
        const qty = Number(quantityInput.value) || 0;
        const price = Number(priceInput.value) || 0;
        totalInput.value = (qty * price).toFixed(2);
        updateSalesTotalAmount();
      };
      
      quantityInput.addEventListener('input', calculateTotal);
      priceInput.addEventListener('input', calculateTotal);
      
      // Remove row button
      itemRow.querySelector('.remove-item-btn').addEventListener('click', () => {
        itemRow.remove();
        updateSalesTotalAmount();
      });
    }
    
    function updateSalesTotalAmount() {
      let total = 0;
      const itemRows = qsa('#editSalesItems .sales-item-row');
      
      itemRows.forEach(row => {
        const totalInput = row.querySelector('.product-total');
        const itemTotal = Number(totalInput.value) || 0;
        total += itemTotal;
      });
      
      qs('#editTotalSalesAmount').textContent = total.toFixed(2);
    }
    
    async function updateSalesOrder() {
      if (!currentSalesId) return;
      
      const customer = qs('#editCustomerName').value.trim();
      const salesDate = qs('#editSalesDate').value;
      const notes = qs('#editSalesNotes').value.trim();
      
      if (!customer) {
        alert('‚ö†Ô∏è Please enter customer name.');
        return;
      }
      
      const items = [];
      const itemRows = qsa('#editSalesItems .sales-item-row');
      
      if (itemRows.length === 0) {
        alert('‚ö†Ô∏è Please add at least one product item.');
        return;
      }
      
      for (const row of itemRows) {
        const sku = row.querySelector('.product-sku').value.trim();
        const productName = row.querySelector('.product-name').value.trim();
        const quantity = Number(row.querySelector('.product-quantity').value);
        const salePrice = Number(row.querySelector('.product-price').value);
        
        if (!sku || !productName || !quantity || !salePrice) {
          alert('‚ö†Ô∏è Please fill in all fields for each product item.');
          return;
        }
        
        if (quantity <= 0) {
          alert('‚ö†Ô∏è Please enter a valid quantity greater than 0.');
          return;
        }
        
        if (salePrice <= 0) {
          alert('‚ö†Ô∏è Please enter a valid sale price greater than 0.');
          return;
        }
        
        // Check stock availability
        const inventoryItem = inventory.find(item => item.sku === sku);
        if (inventoryItem && inventoryItem.quantity < quantity) {
          alert(`‚ùå Insufficient stock for ${productName}. Available: ${inventoryItem.quantity}, Requested: ${quantity}`);
          return;
        }
        
        items.push({
          sku,
          productName,
          quantity,
          salePrice
        });
      }
      
      const salesData = {
        customer,
        salesDate: salesDate || new Date().toISOString().split('T')[0],
        notes,
        items
      };
      
      // Create confirmation message
      let confirmMessage = `Confirm Update Sales Order:\n\nCustomer: ${customer}\nItems: ${items.length}\n\nItems:\n`;
      items.forEach((item, index) => {
        confirmMessage += `${index + 1}. ${item.productName} (${item.sku}) - ${item.quantity} x RM ${item.salePrice.toFixed(2)} = RM ${(item.quantity * item.salePrice).toFixed(2)}\n`;
      });
      confirmMessage += `\nTotal Amount: RM ${salesData.items.reduce((sum, item) => sum + (item.quantity * item.salePrice), 0).toFixed(2)}`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        const res = await apiFetch(`${API_BASE}/sales/${currentSalesId}`, {
          method: 'PUT',
          body: JSON.stringify(salesData)
        });
        
        if (res.ok) {
          alert('‚úÖ Sales order updated successfully!');
          window.location.href = 'inventory.html';
        } else {
          const error = await res.json();
          alert(`‚ùå Failed to update sales order: ${error.message}`);
        }
      } catch (e) {
        console.error('Update sales order error:', e);
        alert('‚ùå Server connection error while updating sales order.');
      }
    }
    
    async function deleteSales() {
      if (!currentSalesId) return;
      
      if (!confirm(`‚ö†Ô∏è Are you sure you want to delete this sales order?\n\nThis action cannot be undone and will revert inventory quantities.`)) return;
      
      try {
        const res = await apiFetch(`${API_BASE}/sales/${currentSalesId}`, { method: 'DELETE' });
        if (res.status === 204) {
          alert('üóëÔ∏è Sales order deleted successfully!');
          window.location.href = 'inventory.html';
        } else {
          alert('‚ùå Failed to delete sales order.');
        }
      } catch (e) {
        console.error(e);
        alert('‚ùå Server connection error while deleting sales order.');
      }
    }
    
    function printSalesInvoice() {
      if (currentSalesId) {
        window.open(`${API_BASE}/sales/invoice/${currentSalesId}`, '_blank');
      }
    }
    
    function cancelEdit() {
      if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
        window.location.href = 'inventory.html';
      }
    }
    
    // Initialize page
    window.addEventListener('load', async () => {
      const adminName = getUsername();
      if(qs('#adminName')) qs('#adminName').textContent = adminName;
      
      // Load inventory for stock checks
      await fetchInventory();
      
      // Load sales details
      await loadSalesDetails();
      
      // Bind events
      qs('#addEditSalesProductItem')?.addEventListener('click', () => addEditSalesProductItem());
      qs('#updateSalesBtn')?.addEventListener('click', updateSalesOrder);
      qs('#printSalesInvoiceBtn')?.addEventListener('click', printSalesInvoice);
      qs('#cancelEditBtn')?.addEventListener('click', cancelEdit);
      qs('#deleteSalesBtn')?.addEventListener('click', deleteSales);
    });
  </script>
</body>
</html>
