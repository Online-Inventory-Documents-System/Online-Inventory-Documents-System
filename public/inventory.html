<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory | Inventory System</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: var(--card-light);
      margin: 2% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 1200px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .dark-mode .modal-content {
      background-color: var(--card-dark);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-color);
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: var(--danger-color);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .purchase-table, .sales-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .purchase-table th, .purchase-table td,
    .sales-table th, .sales-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .purchase-table th, .sales-table th {
      background-color: var(--primary-color);
      color: white;
    }

    .quantity-input, .price-input {
      width: 80px;
      padding: 5px;
      text-align: center;
    }

    .remove-btn {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .totals-section {
      margin-top: 20px;
      padding: 15px;
      background-color: var(--background-light);
      border-radius: 8px;
    }

    .dark-mode .totals-section {
      background-color: #343a40;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .stock-warning {
      color: var(--danger-color);
      font-weight: bold;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <h1>üì¶ Inventory Management</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="inventory.html">Inventory</a>
      <a href="documents.html">Documents</a>
      <a href="log.html">Activity Log</a>
      <a href="setting.html" style="text-decoration: none;"><button>‚öôÔ∏è Setting</button></a>
      <button onclick="toggleTheme()">üåì Mode</button>
      <button onclick="logout()">üö™ Logout</button>
      <div id="adminInfo">Logged in as: <span id="adminName"></span></div>
    </nav>
  </header>

  <section>
    <h2>Add New Product</h2>
    <div class="product-bar">
      <input id="p_sku" placeholder="Item ID / SKU" type="text" />
      <input id="p_name" placeholder="Item Name" type="text" />
      <input id="p_category" placeholder="Category" type="text" />
      <input id="p_quantity" placeholder="Quantity" type="number" min="0" />
      <input id="p_unitCost" placeholder="Unit Cost" type="number" step="0.01" />
      <input id="p_unitPrice" placeholder="Unit Price" type="number" step="0.01" />
      <button id="addProductBtn" class="primary-btn">+ Add Product</button>
    </div>

    <h2>Current Inventory List</h2> 
    <div class="controls">
      <div style="display:flex; gap:10px;">
        <button id="purchaseStockBtn" class="primary-btn">üì• Purchase Stock</button>
        <button id="newSaleBtn" class="success-btn">üõí New Sale</button>
        <button id="reportBtn" class="success-btn">‚¨áÔ∏è Generate Report (Excel)</button>
        <button id="pdfReportBtn" class="primary-btn">üìÑ Generate PDF Inventory Report</button>
      </div>

      <div class="search-controls">
        <!-- Date Range Search Controls -->
        <div class="date-range-container">
          <label for="startDate">üìÖ Date Range:</label>
          <div class="date-inputs">
            <div class="date-input-group">
              <span class="date-label">From:</span>
              <input id="startDate" type="date" />
            </div>
            <div class="date-input-group">
              <span class="date-label">To:</span>
              <input id="endDate" type="date" />
            </div>
            <button id="applyDateRangeBtn" class="primary-btn">Apply</button>
            <button id="clearDateRangeBtn" class="secondary-btn">Clear Dates</button>
          </div>
        </div>
        
        <!-- Text Search -->
        <div class="text-search-container">
          <input id="searchInput" placeholder="Search SKU, name, or category..." type="text" />
          <button id="clearSearchBtn" class="secondary-btn">Clear Text</button>
        </div>
      </div>
    </div>
    
    <div class="table-container"> 
      <table id="inventoryTable">
          <thead>
              <tr>
                  <th>SKU</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Quantity</th>
                  <th class="money">Unit Cost</th>
                  <th class="money">Unit Price</th>
                  <th class="money">Inventory Value</th>
                  <th class="money">Potential Revenue</th>
                  <th class="money">Potential Profit</th>
                  <th>Date</th>
                  <th class="actions">Actions</th>
              </tr>
          </thead>
          <tbody id="inventoryList"></tbody>
      </table>
    </div>

    <div class="totals" id="inventoryTotals">
      <div>Total Inventory Value: RM <span id="totalValue">0.00</span></div>
      <div>Total Potential Revenue: RM <span id="totalRevenue">0.00</span></div>
      <div>Total Potential Profit: RM <span id="totalProfit">0.00</span></div>
      <div>Total Stock Quantity: <span id="totalStock">0</span></div>
    </div>
  </section>

  <!-- Purchase Modal -->
  <div id="purchaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì• Purchase Stock</h2>
        <span class="close" onclick="closePurchaseModal()">&times;</span>
      </div>
      
      <div class="form-group">
        <label for="supplierName">Supplier:</label>
        <input type="text" id="supplierName" placeholder="Enter supplier name" style="width: 300px;">
      </div>

      <div class="form-group">
        <label for="productSearch">Add Product:</label>
        <select id="productSearch" style="width: 400px;">
          <option value="">Select a product...</option>
        </select>
        <button onclick="addProductToPurchase()" class="primary-btn">Add to Purchase</button>
      </div>

      <div class="table-container">
        <table class="purchase-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>SKU</th>
              <th>Current Stock</th>
              <th>Quantity</th>
              <th>Cost Price (RM)</th>
              <th>Subtotal (RM)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="purchaseItems">
            <!-- Purchase items will be added here dynamically -->
          </tbody>
        </table>
      </div>

      <div class="totals-section">
        <div style="font-size: 1.2em; font-weight: bold;">
          Grand Total: RM <span id="purchaseGrandTotal">0.00</span>
        </div>
      </div>

      <div class="form-group">
        <label for="purchaseNotes">Notes:</label>
        <textarea id="purchaseNotes" placeholder="Any additional notes..." style="width: 100%; height: 80px;"></textarea>
      </div>

      <div class="action-buttons">
        <button onclick="generatePurchaseOrderPDF()" class="primary-btn">üìÑ Generate Purchase Order</button>
        <button onclick="submitPurchase()" class="success-btn">üíæ Add to Inventory</button>
        <button onclick="closePurchaseModal()" class="secondary-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Sales Modal -->
  <div id="salesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üõí New Sale</h2>
        <span class="close" onclick="closeSalesModal()">&times;</span>
      </div>
      
      <div class="form-group">
        <label for="customerName">Customer:</label>
        <input type="text" id="customerName" placeholder="Enter customer name" style="width: 300px;">
      </div>

      <div class="form-group">
        <label for="paymentMethod">Payment Method:</label>
        <select id="paymentMethod" style="width: 200px;">
          <option value="Cash">Cash</option>
          <option value="Credit Card">Credit Card</option>
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label for="salesProductSearch">Add Product:</label>
        <select id="salesProductSearch" style="width: 400px;">
          <option value="">Select a product...</option>
        </select>
        <button onclick="addProductToSale()" class="primary-btn">Add to Sale</button>
      </div>

      <div class="table-container">
        <table class="sales-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>SKU</th>
              <th>Current Stock</th>
              <th>Quantity</th>
              <th>Selling Price (RM)</th>
              <th>Subtotal (RM)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="salesItems">
            <!-- Sales items will be added here dynamically -->
          </tbody>
        </table>
      </div>

      <div class="totals-section">
        <div style="font-size: 1.2em; font-weight: bold;">
          Grand Total: RM <span id="salesGrandTotal">0.00</span>
        </div>
      </div>

      <div class="form-group">
        <label for="salesNotes">Notes:</label>
        <textarea id="salesNotes" placeholder="Any additional notes..." style="width: 100%; height: 80px;"></textarea>
      </div>

      <div class="action-buttons">
        <button onclick="generateSalesInvoicePDF()" class="primary-btn">üìÑ Print Invoice</button>
        <button onclick="submitSale()" class="success-btn">‚úÖ Complete Sale</button>
        <button onclick="closeSalesModal()" class="secondary-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="js/setting.js" defer></script>
  <script src="js/script.js" defer></script>
  <script>
    document.documentElement.dataset.page = 'inventory';

    // Purchase and Sales Modal Functions
    let purchaseItems = [];
    let salesItems = [];
    let currentPurchaseId = null;
    let currentSaleId = null;

    function openPurchaseModal() {
      document.getElementById('purchaseModal').style.display = 'block';
      populateProductDropdown('productSearch');
      purchaseItems = [];
      updatePurchaseTable();
      updatePurchaseTotal();
    }

    function closePurchaseModal() {
      document.getElementById('purchaseModal').style.display = 'none';
      purchaseItems = [];
      document.getElementById('supplierName').value = '';
      document.getElementById('purchaseNotes').value = '';
    }

    function openSalesModal() {
      document.getElementById('salesModal').style.display = 'block';
      populateProductDropdown('salesProductSearch');
      salesItems = [];
      updateSalesTable();
      updateSalesTotal();
    }

    function closeSalesModal() {
      document.getElementById('salesModal').style.display = 'none';
      salesItems = [];
      document.getElementById('customerName').value = '';
      document.getElementById('salesNotes').value = '';
      document.getElementById('paymentMethod').value = 'Cash';
    }

    function populateProductDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      dropdown.innerHTML = '<option value="">Select a product...</option>';
      
      inventory.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.name} (${product.sku}) - Stock: ${product.quantity}`;
        option.dataset.product = JSON.stringify(product);
        dropdown.appendChild(option);
      });
    }

    function addProductToPurchase() {
      const dropdown = document.getElementById('productSearch');
      const selectedOption = dropdown.options[dropdown.selectedIndex];
      
      if (!selectedOption.value) {
        alert('Please select a product');
        return;
      }

      const product = JSON.parse(selectedOption.dataset.product);
      
      // Check if product already exists in purchase items
      const existingItem = purchaseItems.find(item => item.productId === product.id);
      if (existingItem) {
        existingItem.quantity += 1;
        existingItem.subtotal = existingItem.quantity * existingItem.costPrice;
      } else {
        purchaseItems.push({
          productId: product.id,
          sku: product.sku,
          name: product.name,
          quantity: 1,
          costPrice: product.unitCost || 0,
          subtotal: product.unitCost || 0
        });
      }

      updatePurchaseTable();
      updatePurchaseTotal();
      dropdown.selectedIndex = 0;
    }

    function addProductToSale() {
      const dropdown = document.getElementById('salesProductSearch');
      const selectedOption = dropdown.options[dropdown.selectedIndex];
      
      if (!selectedOption.value) {
        alert('Please select a product');
        return;
      }

      const product = JSON.parse(selectedOption.dataset.product);
      
      // Check if product already exists in sales items
      const existingItem = salesItems.find(item => item.productId === product.id);
      if (existingItem) {
        existingItem.quantity += 1;
        existingItem.subtotal = existingItem.quantity * existingItem.sellingPrice;
      } else {
        salesItems.push({
          productId: product.id,
          sku: product.sku,
          name: product.name,
          quantity: 1,
          sellingPrice: product.unitPrice || 0,
          subtotal: product.unitPrice || 0
        });
      }

      updateSalesTable();
      updateSalesTotal();
      dropdown.selectedIndex = 0;
    }

    function updatePurchaseTable() {
      const tbody = document.getElementById('purchaseItems');
      tbody.innerHTML = '';

      purchaseItems.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.sku}</td>
          <td>${getCurrentStock(item.productId)}</td>
          <td>
            <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                   onchange="updatePurchaseQuantity(${index}, this.value)">
          </td>
          <td>
            <input type="number" class="price-input" value="${item.costPrice.toFixed(2)}" step="0.01" 
                   onchange="updatePurchaseCost(${index}, this.value)">
          </td>
          <td>RM ${item.subtotal.toFixed(2)}</td>
          <td>
            <button class="remove-btn" onclick="removePurchaseItem(${index})">Remove</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateSalesTable() {
      const tbody = document.getElementById('salesItems');
      tbody.innerHTML = '';

      salesItems.forEach((item, index) => {
        const currentStock = getCurrentStock(item.productId);
        const isOutOfStock = item.quantity > currentStock;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.sku}</td>
          <td>${currentStock}</td>
          <td>
            <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                   max="${currentStock}" onchange="updateSalesQuantity(${index}, this.value)">
            ${isOutOfStock ? '<div class="stock-warning">Exceeds stock!</div>' : ''}
          </td>
          <td>
            <input type="number" class="price-input" value="${item.sellingPrice.toFixed(2)}" step="0.01" 
                   onchange="updateSalesPrice(${index}, this.value)">
          </td>
          <td>RM ${item.subtotal.toFixed(2)}</td>
          <td>
            <button class="remove-btn" onclick="removeSalesItem(${index})">Remove</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function getCurrentStock(productId) {
      const product = inventory.find(p => p.id === productId);
      return product ? product.quantity : 0;
    }

    function updatePurchaseQuantity(index, quantity) {
      quantity = parseInt(quantity) || 1;
      purchaseItems[index].quantity = quantity;
      purchaseItems[index].subtotal = quantity * purchaseItems[index].costPrice;
      updatePurchaseTable();
      updatePurchaseTotal();
    }

    function updatePurchaseCost(index, cost) {
      cost = parseFloat(cost) || 0;
      purchaseItems[index].costPrice = cost;
      purchaseItems[index].subtotal = purchaseItems[index].quantity * cost;
      updatePurchaseTable();
      updatePurchaseTotal();
    }

    function updateSalesQuantity(index, quantity) {
      quantity = parseInt(quantity) || 1;
      const currentStock = getCurrentStock(salesItems[index].productId);
      
      if (quantity > currentStock) {
        alert(`Cannot sell more than available stock! Available: ${currentStock}`);
        quantity = currentStock;
      }
      
      salesItems[index].quantity = quantity;
      salesItems[index].subtotal = quantity * salesItems[index].sellingPrice;
      updateSalesTable();
      updateSalesTotal();
    }

    function updateSalesPrice(index, price) {
      price = parseFloat(price) || 0;
      salesItems[index].sellingPrice = price;
      salesItems[index].subtotal = salesItems[index].quantity * price;
      updateSalesTable();
      updateSalesTotal();
    }

    function removePurchaseItem(index) {
      purchaseItems.splice(index, 1);
      updatePurchaseTable();
      updatePurchaseTotal();
    }

    function removeSalesItem(index) {
      salesItems.splice(index, 1);
      updateSalesTable();
      updateSalesTotal();
    }

    function updatePurchaseTotal() {
      const grandTotal = purchaseItems.reduce((total, item) => total + item.subtotal, 0);
      document.getElementById('purchaseGrandTotal').textContent = grandTotal.toFixed(2);
    }

    function updateSalesTotal() {
      const grandTotal = salesItems.reduce((total, item) => total + item.subtotal, 0);
      document.getElementById('salesGrandTotal').textContent = grandTotal.toFixed(2);
    }

    async function submitPurchase() {
      if (purchaseItems.length === 0) {
        alert('Please add at least one product to the purchase');
        return;
      }

      const supplier = document.getElementById('supplierName').value || 'Unknown Supplier';
      const notes = document.getElementById('purchaseNotes').value;

      try {
        const response = await apiFetch(`${API_BASE}/purchases`, {
          method: 'POST',
          body: JSON.stringify({
            items: purchaseItems,
            supplier,
            notes
          })
        });

        if (response.ok) {
          const result = await response.json();
          currentPurchaseId = result.id;
          alert('Purchase completed successfully! Inventory updated.');
          await fetchInventory();
          closePurchaseModal();
        } else {
          const error = await response.json();
          alert('Error: ' + error.message);
        }
      } catch (error) {
        console.error('Purchase error:', error);
        alert('Error submitting purchase: ' + error.message);
      }
    }

    async function submitSale() {
      if (salesItems.length === 0) {
        alert('Please add at least one product to the sale');
        return;
      }

      // Validate stock availability
      for (const item of salesItems) {
        const currentStock = getCurrentStock(item.productId);
        if (item.quantity > currentStock) {
          alert(`Cannot complete sale: ${item.name} quantity (${item.quantity}) exceeds available stock (${currentStock})`);
          return;
        }
      }

      const customer = document.getElementById('customerName').value || 'Walk-in Customer';
      const paymentMethod = document.getElementById('paymentMethod').value;
      const notes = document.getElementById('salesNotes').value;

      try {
        const response = await apiFetch(`${API_BASE}/sales`, {
          method: 'POST',
          body: JSON.stringify({
            items: salesItems,
            customer,
            paymentMethod,
            notes
          })
        });

        if (response.ok) {
          const result = await response.json();
          currentSaleId = result.id;
          alert('Sale completed successfully! Inventory updated.');
          await fetchInventory();
          closeSalesModal();
        } else {
          const error = await response.json();
          alert('Error: ' + error.message);
        }
      } catch (error) {
        console.error('Sale error:', error);
        alert('Error submitting sale: ' + error.message);
      }
    }

    async function generatePurchaseOrderPDF() {
      if (purchaseItems.length === 0) {
        alert('Please add at least one product to generate a purchase order');
        return;
      }

      // First submit the purchase if not already submitted
      if (!currentPurchaseId) {
        const supplier = document.getElementById('supplierName').value || 'Unknown Supplier';
        const notes = document.getElementById('purchaseNotes').value;

        try {
          const response = await apiFetch(`${API_BASE}/purchases`, {
            method: 'POST',
            body: JSON.stringify({
              items: purchaseItems,
              supplier,
              notes
            })
          });

          if (response.ok) {
            const result = await response.json();
            currentPurchaseId = result.id;
          } else {
            const error = await response.json();
            alert('Error creating purchase: ' + error.message);
            return;
          }
        } catch (error) {
          console.error('Purchase error:', error);
          alert('Error creating purchase: ' + error.message);
          return;
        }
      }

      // Generate PDF
      window.open(`${API_BASE}/purchases/${currentPurchaseId}/pdf`, '_blank');
    }

    async function generateSalesInvoicePDF() {
      if (salesItems.length === 0) {
        alert('Please add at least one product to generate an invoice');
        return;
      }

      // First submit the sale if not already submitted
      if (!currentSaleId) {
        const customer = document.getElementById('customerName').value || 'Walk-in Customer';
        const paymentMethod = document.getElementById('paymentMethod').value;
        const notes = document.getElementById('salesNotes').value;

        try {
          const response = await apiFetch(`${API_BASE}/sales`, {
            method: 'POST',
            body: JSON.stringify({
              items: salesItems,
              customer,
              paymentMethod,
              notes
            })
          });

          if (response.ok) {
            const result = await response.json();
            currentSaleId = result.id;
          } else {
            const error = await response.json();
            alert('Error creating sale: ' + error.message);
            return;
          }
        } catch (error) {
          console.error('Sale error:', error);
          alert('Error creating sale: ' + error.message);
          return;
        }
      }

      // Generate PDF
      window.open(`${API_BASE}/sales/${currentSaleId}/pdf`, '_blank');
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('purchaseStockBtn')?.addEventListener('click', openPurchaseModal);
      document.getElementById('newSaleBtn')?.addEventListener('click', openSalesModal);
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
      const purchaseModal = document.getElementById('purchaseModal');
      const salesModal = document.getElementById('salesModal');
      
      if (event.target === purchaseModal) {
        closePurchaseModal();
      }
      if (event.target === salesModal) {
        closeSalesModal();
      }
    };
  </script>
</body>
</html>
