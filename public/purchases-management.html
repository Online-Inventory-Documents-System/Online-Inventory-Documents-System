<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Purchases | Inventory System</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: var(--card-light);
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      box-shadow: var(--shadow-md);
    }
    .dark-mode .modal-content {
      background-color: var(--card-dark);
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: var(--danger-color);
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .search-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <header>
    <h1>üì• Purchase Management</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="inventory.html">Inventory</a>
      <a href="documents.html">Documents</a>
      <a href="log.html">Activity Log</a>
      <a href="purchases-management.html" style="text-decoration: none;"><button>üì• Manage Purchases</button></a>
      <a href="sales-management.html" style="text-decoration: none;"><button>üì§ Manage Sales</button></a>
      <a href="setting.html" style="text-decoration: none;"><button>‚öôÔ∏è Setting</button></a>
      <button onclick="toggleTheme()">üåì Mode</button>
      <button onclick="logout()">üö™ Logout</button>
      <div id="adminInfo">Logged in as: <span id="adminName"></span></div>
    </nav>
  </header>

  <section>
    <h2>Purchase History</h2>
    
    <div class="search-controls">
      <input type="text" id="purchaseSearch" placeholder="Search by product, supplier..." style="flex: 1;">
      <input type="date" id="purchaseStartDate">
      <input type="date" id="purchaseEndDate">
      <button onclick="filterPurchases()" class="primary-btn">Filter</button>
      <button onclick="clearPurchaseFilters()" class="secondary-btn">Clear</button>
    </div>

    <div class="table-container">
      <table id="purchasesTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Product</th>
            <th>SKU</th>
            <th>Supplier</th>
            <th>Quantity</th>
            <th>Unit Cost</th>
            <th>Total Cost</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="purchasesList"></tbody>
      </table>
    </div>

    <div class="totals">
      <div>Total Purchases: <span id="totalPurchases">0</span> records</div>
      <div>Total Quantity: <span id="totalPurchaseQuantity">0</span> units</div>
      <div>Total Cost: RM <span id="totalPurchaseCost">0.00</span></div>
    </div>
  </section>

  <!-- Edit Purchase Modal -->
  <div id="editPurchaseModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditPurchaseModal()">&times;</span>
      <h2>Edit Purchase</h2>
      
      <div class="form-group">
        <label>Product:</label>
        <input type="text" id="editPurchaseProduct" readonly>
      </div>
      
      <div class="form-group">
        <label for="editPurchaseQuantity">Quantity:</label>
        <input type="number" id="editPurchaseQuantity" min="1" required>
      </div>
      
      <div class="form-group">
        <label for="editPurchaseUnitCost">Unit Cost (RM):</label>
        <input type="number" id="editPurchaseUnitCost" step="0.01" min="0" required>
      </div>
      
      <div class="form-group">
        <label for="editPurchaseSupplier">Supplier:</label>
        <input type="text" id="editPurchaseSupplier" required>
      </div>
      
      <div class="form-group">
        <label for="editPurchaseDate">Date:</label>
        <input type="date" id="editPurchaseDate">
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="updatePurchase()" class="primary-btn" style="flex: 1;">Update Purchase</button>
        <button onclick="closeEditPurchaseModal()" class="secondary-btn" style="flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <script src="js/setting.js" defer></script>
  <script src="js/script.js" defer></script>
  <script>
    document.documentElement.dataset.page = 'purchases-management';
    let purchases = [];
    let currentEditPurchaseId = null;

    async function loadPurchases() {
      try {
        const response = await fetch(`${window.API_BASE}/purchases`);
        if (response.ok) {
          purchases = await response.json();
          renderPurchases();
        }
      } catch (error) {
        console.error('Error loading purchases:', error);
      }
    }

    function renderPurchases(filteredPurchases = null) {
      const list = document.getElementById('purchasesList');
      const data = filteredPurchases || purchases;
      
      list.innerHTML = '';
      
      let totalQuantity = 0;
      let totalCost = 0;

      data.forEach(purchase => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${new Date(purchase.date).toLocaleDateString()}</td>
          <td>${purchase.productName}</td>
          <td>${purchase.sku}</td>
          <td>${purchase.supplier}</td>
          <td>${purchase.quantityReceived}</td>
          <td>RM ${purchase.unitCost.toFixed(2)}</td>
          <td>RM ${purchase.totalCost.toFixed(2)}</td>
          <td>
            <button class="primary-btn small-btn" onclick="openEditPurchaseModal('${purchase.id}')">Edit</button>
            <button class="danger-btn small-btn" onclick="deletePurchase('${purchase.id}')">Delete</button>
          </td>
        `;
        list.appendChild(row);
        
        totalQuantity += purchase.quantityReceived;
        totalCost += purchase.totalCost;
      });

      document.getElementById('totalPurchases').textContent = data.length;
      document.getElementById('totalPurchaseQuantity').textContent = totalQuantity;
      document.getElementById('totalPurchaseCost').textContent = totalCost.toFixed(2);
    }

    function filterPurchases() {
      const searchTerm = document.getElementById('purchaseSearch').value.toLowerCase();
      const startDate = document.getElementById('purchaseStartDate').value;
      const endDate = document.getElementById('purchaseEndDate').value;

      const filtered = purchases.filter(purchase => {
        const matchesSearch = !searchTerm || 
          purchase.productName.toLowerCase().includes(searchTerm) ||
          purchase.sku.toLowerCase().includes(searchTerm) ||
          purchase.supplier.toLowerCase().includes(searchTerm);
        
        const purchaseDate = new Date(purchase.date);
        const matchesStartDate = !startDate || purchaseDate >= new Date(startDate);
        const matchesEndDate = !endDate || purchaseDate <= new Date(endDate + 'T23:59:59');
        
        return matchesSearch && matchesStartDate && matchesEndDate;
      });

      renderPurchases(filtered);
    }

    function clearPurchaseFilters() {
      document.getElementById('purchaseSearch').value = '';
      document.getElementById('purchaseStartDate').value = '';
      document.getElementById('purchaseEndDate').value = '';
      renderPurchases();
    }

    function openEditPurchaseModal(purchaseId) {
      const purchase = purchases.find(p => p.id === purchaseId);
      if (purchase) {
        currentEditPurchaseId = purchaseId;
        document.getElementById('editPurchaseProduct').value = purchase.productName;
        document.getElementById('editPurchaseQuantity').value = purchase.quantityReceived;
        document.getElementById('editPurchaseUnitCost').value = purchase.unitCost;
        document.getElementById('editPurchaseSupplier').value = purchase.supplier;
        document.getElementById('editPurchaseDate').value = new Date(purchase.date).toISOString().split('T')[0];
        document.getElementById('editPurchaseModal').style.display = 'block';
      }
    }

    function closeEditPurchaseModal() {
      document.getElementById('editPurchaseModal').style.display = 'none';
      currentEditPurchaseId = null;
    }

    async function updatePurchase() {
      if (!currentEditPurchaseId) return;

      const quantity = parseInt(document.getElementById('editPurchaseQuantity').value);
      const unitCost = parseFloat(document.getElementById('editPurchaseUnitCost').value);
      const supplier = document.getElementById('editPurchaseSupplier').value;
      const date = document.getElementById('editPurchaseDate').value;

      if (!quantity || !unitCost || !supplier) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch(`${window.API_BASE}/purchases/${currentEditPurchaseId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Username': window.getUsername()
          },
          body: JSON.stringify({
            quantityReceived: quantity,
            unitCost: unitCost,
            supplier: supplier,
            date: date
          })
        });

        if (response.ok) {
          alert('Purchase updated successfully!');
          closeEditPurchaseModal();
          await loadPurchases();
        } else {
          const error = await response.json();
          alert('Error updating purchase: ' + error.message);
        }
      } catch (error) {
        console.error('Error updating purchase:', error);
        alert('Error updating purchase');
      }
    }

    async function deletePurchase(purchaseId) {
      if (!confirm('Are you sure you want to delete this purchase?')) return;

      try {
        const response = await fetch(`${window.API_BASE}/purchases/${purchaseId}`, {
          method: 'DELETE',
          headers: {
            'X-Username': window.getUsername()
          }
        });

        if (response.ok) {
          alert('Purchase deleted successfully!');
          await loadPurchases();
        } else {
          const error = await response.json();
          alert('Error deleting purchase: ' + error.message);
        }
      } catch (error) {
        console.error('Error deleting purchase:', error);
        alert('Error deleting purchase');
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('editPurchaseModal');
      if (event.target === modal) {
        closeEditPurchaseModal();
      }
    }

    // Load purchases when page loads
    document.addEventListener('DOMContentLoaded', loadPurchases);
  </script>
</body>
</html>
